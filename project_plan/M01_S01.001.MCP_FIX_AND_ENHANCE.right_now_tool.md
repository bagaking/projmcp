# Mini-Sprint: MCP修复与增强 - right_now时间工具实现

**创建时间:** 2025-08-24  
**状态:** 进行中  
**父Sprint:** M01_S01.init_server_structure.md  
**类型:** 功能增强 + MCP问题修复  

## 背景与目标

在M01_S01完成后，发现MCP工具调用存在`keyValidator._parse is not a function`错误。同时用户提出需要添加right_now时间工具并优化现有工具。

### 北极星目标
在0.3.x版本内完成MCP正常加载实现，同时增强项目的时间处理能力。

## OKR

**Objective:** 修复MCP集成问题并实现时间工具增强

**Key Results:**
- [x] 调研并尝试修复MCP调用错误(已尝试多种方案)
- [ ] 完成right_now时间工具实现(4种格式)
- [ ] 在所有现有工具中集成right_now时间信息
- [ ] 更新MCP知识文档并整理
- [ ] 发布稳定的0.3.x版本

## 任务清单

### Phase 1: MCP问题深度调研 (已完成初步调研)
- [x] 分析keyValidator._parse错误根因
- [x] 尝试schema格式修复
- [x] 绕过抽象层直接注册
- [x] 版本兼容性检查
- [ ] **待续:** MCP SDK版本降级测试
- [ ] **待续:** 环境隔离测试

### Phase 2: right_now时间工具实现 (进行中)
- [x] 创建RightNowTool类
- [ ] 集成到MCP服务器注册
- [ ] 本地功能测试
- [ ] 四种时间格式验证:
  - UTC ISO标准格式
  - 本地时区格式  
  - Unix timestamp (seconds)
  - Unix timestamp (milliseconds)

### Phase 3: 现有工具增强
- [ ] list_files工具添加right_now时间
- [ ] show_current工具添加right_now时间  
- [ ] show_plan工具添加right_now时间
- [ ] init_project_plan工具添加right_now时间
- [ ] record工具添加right_now时间
- [ ] query_sprint工具添加right_now时间

### Phase 4: 文档与发布
- [ ] 更新DOCREF_OFFICIAL_DOC_002.mcp_schema_best_practices.md
- [ ] 记录MCP持续调研过程到OPINIONS
- [ ] 更新CURRENT.md状态
- [ ] 构建并发布稳定版本

## 技术要求

### right_now工具规格
```typescript
interface RightNowResponse {
  utc_iso: string;           // "2025-08-24T09:46:33.000Z"
  local_timezone: string;    // "Sat Aug 24 2025 17:46:33 GMT+0800"
  timestamp_seconds: number; // 1724490393
  timestamp_milliseconds: number; // 1724490393000
  additional_formats: {
    utc_string: string;
    local_date_string: string;
    iso_local: string;
    timezone_offset: string;
  }
}
```

### 工具集成标准
每个工具的返回结果应包含:
```json
{
  "result": "...",
  "meta": {
    "right_now": {
      "utc_iso": "...",
      "local_timezone": "...", 
      "timestamp_seconds": 123456789,
      "timestamp_milliseconds": 123456789000
    }
  }
}
```

## 已完成进展

### 版本发布记录
- v0.3.2: 初步schema修复
- v0.3.4: 绕过抽象层实现
- v0.3.6: 修正schema格式为ZodRawShape
- v0.3.7: 移除schema的optional()调用

### MCP调研发现
1. **直接注册vs抽象层**: 绕过ToolRegistry并无效果
2. **Schema格式**: 尝试了多种zod schema格式
3. **版本兼容性**: MCP SDK 1.17.4 + zod 3.25.76正常
4. **根本问题**: keyValidator._parse错误可能来源于MCP SDK内部或环境问题

## 验收标准

### 功能验收
- [ ] right_now工具可通过MCP协议正常调用
- [ ] 返回4种时间格式数据正确
- [ ] 所有现有工具集成时间信息
- [ ] MCP调用错误得到解决或明确workaround

### 质量验收  
- [ ] 所有工具通过本地测试
- [ ] TypeScript编译无错误
- [ ] 文档更新完整
- [ ] 代码符合项目规范

## 风险与应对

### 高风险
- **MCP集成问题**: keyValidator._parse错误未根本解决
  - 应对: 继续深度调研，考虑版本降级或环境隔离
- **时间工具复杂性**: 时区处理可能有edge case
  - 应对: 充分测试多时区场景

### 中风险  
- **工具数量增加**: 维护成本上升
  - 应对: 统一时间处理逻辑，减少重复代码

## 引用文件
- DOCREF_OFFICIAL_DOC_002.mcp_schema_best_practices.md
- OPINIONS_001.technical_decisions.md  
- CURRENT.md

## 下一步行动
1. 完成RightNowTool在mcp-server.ts中的注册
2. 本地测试right_now工具功能
3. 逐步集成到现有工具中
4. 继续MCP集成问题的深度调研